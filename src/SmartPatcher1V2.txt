SmartPatcher v1.2!
Создатель – Клименко Алексей.

Эта программа позволяет быстро создавать и применять небольшие патчи для различных файлов в интерактивном и автоматическом режиме.

Изменения второго издания:
– Уменьшен размер файлов-патчей из-за оптимизации метаданных (списков смещений-размеров), теперь патчи старой версии не поддерживаются;
– Теперь сравнение и подсчёт CRC ведётся внутренними средствами без запуска отдельных программ,  за счёт чего повышена скорость;
– Добавлен автоматический интерфейс для batch-сценариев;
– При прямом запуске патча теперь выводится краткая информация о размерах и CRC суммах предполагаемых файлов.
– Модуль PatchCreator отныне не удаляется из временной папки, и возможна работа сразу нескольких копий программы;
– При создании патча файлы более не блокируются, из-за чего теперь технически возможно указывать в качестве обоих версий один и тот же файл;
– Улучшена команда запуска, исправлены мелкие ошибки.

Патч – это набор части оригинальных и изменённых данных какого-нибудь файла. С его помощью можно внести изменения в такой же файл, чтобы преобразовать его к изменённому состоянию.
Выгода (по сравнению с цельным копированием) в том, что размер патча зависит только от количества различных (изменённых) байт, и обычно получается гораздо меньше самого файла.
Также легко объединять патчи одного и того же файла, если они не пересекаются (модифицируют разные части).
Благодаря сохранению оригинальных данных вместе с изменёнными, любой наложенный патч можно легко отменить, вернув файл к исходному состоянию.
Если необходимые патчу данные не совпадают с предполагаемыми исходными, то предварительно создаётся архивный патч для такого файла, который поможет отменить внесённые изменения (поэтому безопасно применять патч к неподходящему файлу, ведь его всегда можно вернуть к первоначальной версии)

Использование. Патч создаётся двумя способами. Но сначала вам понадобиться иметь ДВЕ версии вашего файла, к которому вы делаете патч.
Одна – исходная, а другая – модифицированная. (По сути они равноправны, но патчер первым делом приводит к изменённому состоянию, чем к оригиналу)
Желательно, чтобы обе версии были одинакового размера, потому что патчер не может дописать или вырезать что-либо, он только вносит изменения.
Сам патч – это «*.bat»-файл командного сценария, однако в нём лишь первая строка выполняет запуск, а далее следуют двоичные данные.
Запустите SmartPatcher напрямую двойным щелчком. Откроется PatchCreator (который на самом деле является активированным batch-файлом)
Перетащите в консольное окно первый оригинальный файл и нажмите Enter.
Затем перетащите изменённый файл в это же окно и нажмите Enter ещё раз.
Теперь задайте имя для сохранения результата или перетащите тот файл, в который согласны записать новый патч (его расширение будет автоматически изменено на .bat)
После вывода информации и сравнения содержимого, патч сохранится по заданному имени.

Для применения готового патча, просто перетащите нужный вам файл на него (на .bat). Патч будет применён к перетащенному файлу. Однако сам SmartPatcher1V2.exe должен находиться в текущей папке. Чтобы избавится от этого условия, скопируйте программу в системную директорию (например Windows или System32)
Для снятия патча повторите процедуру, следя за интерактивным диалогом. А вот и его описание:

«Patch creator! STEP X/4 For SmartPatcher:» – приветствие сценария создания патча. Указан текущий шаг (0 – ошибка, 1 – оригинал, 2 – изменённый, 3 – сохранение, 4 – исполнение)
«`SmartPatcher1V2.exe' not found!» – выводится, если скрипт «SmartPatcher1V2.PatchCreator.cmd» запущен там, где нет самого патчера или если первый аргумент не соответствует его имени.
«Original file not found!» / «Modified file not found!» – по введённой строке не найден файл.
«Wrong filename for patch!» – по строке нет существующего файла, а также невозможно создать новый, что означает неверный адрес.
«Starting `Patch Creator` error!» – ошибка запуска сценария создания патча из временной папки. Обычно не происходит.
«Drag and drop target file to BAT to use this patch!» – выводится, если BAT файл патча запущен напрямую без аргументов. Там же можно увидеть информацию о размерах и суммах предполагаемых файлов.
«SmartPatcher v1.2! Kly_Men_COmpany.» – приветствие программы. Всё, выведенное далее в рамку, создано самим патчером.
«Original file not found!» / «Modified file not found!» – не существует соответствующий файл. Обычно не выводится, поскольку пресекается ещё при работе PatchCreator.
«Input files open error!» – ошибка открытия исходных файлов.
«Input files different sizes!» – Предупреждение о том, что сравниваемые файлы разного размера. При этом более длинный останется «недосмотренным», поскольку сравнивается лишь общая часть. Также это приведёт к тому, что патч иногда будет выдавать предупреждение о различии CRC. Если вы хотите продолжить, то нажмите Enter.
«Input files seem identical!» – Предупреждение о том, что CRC суммы исходных файлов равны. Это может значить, что они одинаковые, тогда нет смысла делать патч. Если же вы уверены, что файлы различны, нажмите Enter.
«Cannot create target file!» – ошибка создания конечного файла для сохранения.
«Patch script not found!» – не найден .bat-файл самого патча. Обычно так не происходит, если только не передавать аргументы вручную.
«Target file not found!» – не найден файл, который необходимо пропатчить. Так может случиться, если вы запустите патч с неверными параметрами, вместо перетаскивания на него.
«File open error!» – ошибка открытия патчуемого файла или реже – самого патча.
«Patch script wrong!» – повреждённая структура .bat-патча. Может выводиться также если вы перетащите два файла на SmartPatcher (однако на него вообще перетаскивать что-либо не рекомендуется!)
«Target file size maybe wrong for this patch!» – предупреждение о том, что размер патчуемого файла не совпадает с необходимым размером, записанном в патче. Сигнализирует о том, что вы, возможно, перетащили не тот файл. Несмотря на это, можно продолжить, нажав Enter (тогда патч, скорее всего, сработает не полностью, а только на общую часть)
«Target file CRC seems incorrect for this patch!» – размер файла совпадает с ожидаемым, но CRC сумма неверна ни к оригиналу, ни к модификату. Это значит, что ваша версия файла отлична от той, для которой делался патч. Можно продолжить, нажав Enter.
«Patch cannot be applied!» – патч ничего не изменил в перетащенном файле. Возможно, он был неправильно создан, или же ваш файл слишком мал, чтобы хоть что-то в нём менять.
«File already was patched! Restore to original ?» – частый вопрос о том, вернуть ли файл к оригинальной версии. Возникает, когда соответствующие части перетащенного файла оказались равны модифицированным данным, то есть патч уже применён. Следовательно, вы хотите отменить патч, преобразовав ваш файл обратно в оригинальный – нажмите Enter для этого.
«Target is different than original or patched data!» – серьезное предупреждение о том, что в файле найдены данные, которые противоречат как оригинальным, так и модифицированным из патча. Это значит, что применение патча к такому файлу неизбежно и необратимо повредит его, затерев неизвестные байты. Часто происходит, когда вы пытаетесь применить патч к абсолютно неподходящему для него файлу. Однако вы можете продолжить, нажав Enter – тогда перед непосредственным наложением патча произойдёт архивное копирование текущих данных в новый уникальный патч.
«Cannot Create .backup_X.bat file!» – ошибка создания нового файла с именем перетащенного + «.backup_X.bat», где «X» – номер. Для первого будет равен 1, для последующих – на единицу больше (как при создании «новой папки»). Таким образом уже существующие резервные патчи никогда не стираются. Подобной ошибки обычно не происходит.
«I/O error!» – общая ошибка ввода-вывода, появляется в тот момент, когда невозможно что-то записать в файл или прочитать. Происходит редко, ведь ошибки открытия выводятся отдельно.
«Wrong usage!» – слишком много параметров командной строки передано. Как причина – отсутствие кавычек у имён файлов, но PatchCreator борется с этим как может.

Этапы работы обозначают следующее:
«Comparing...» – просчёт CRC суммы исходных файла (файлов).
«Creating...» – происходит последовательное сравнение файлов, и при обнаружении различий они копируются в патч.
«Testing...» – содержимое перетащенного файла сравнивается с оригинальными и модифицированными частями патча.
«Restoring...» – в перетащенный файл записываются данные оригинала, тогда как он целиком соответствовал уже пропатченному.
«Patching...» – патч непосредственно применяется к перетащенному файлу.
«Backuping...» – поскольку «Testing» выявил различия, файл предварительно архивируется в новый патч, имя которого вычисляется перед копированием данных.
«Done!» – операция успешно завершена, нажмите Enter чтобы закрыть окно.

Интерактивные указания бывают только двух типов:
«Press ENTER to continue:» – Прочитайте предупреждение и нажмите Enter чтобы продолжить работу. Если же вы не согласны и хотите прекратить операцию, то закройте окно или нажмите Ctrl+C (или даже Ctrl+Break).
«Press ENTER to exit program...» – продолжение невозможно, нажмите Enter, чтобы выйти из программы. Выводится при обнаружении ошибки или успешном выполнении задания, что можно понять из предшествующего текста.

Единственный временный файл, оставляемый программой – это:
«SmartPatcher1V2.PatchCreator.cmd» – сценарий для создания патча. Выгружается и перезаписывается только при запуске патчера без параметров, где сразу же передаётся на исполнение; никогда не удаляется.

Описание параметров командной строки:
«SmartPatcher.exe» –
Запуск CMD для создателя патча и немедленное завершение своей работы.
«SmartPatcher.exe %1» –
Вывод информации о патче и сообщение о том, что для использования нужно перетащить файл.
«SmartPatcher.exe %1 %2» –
Загрузка патча из файла %1 и применение его к файлу %2.
«SmartPatcher.exe %1 %2 %3» –
Сравнение файлов %1 и %2, сохранение готового патча в %3.
Команды автоматического режима:
«SmartPatcher.exe %1 %2 * *» –
Загрузка патча из файла %1 и применение его к файлу %2. Правила пропатчивания те же, что и при обычной работе – если файл оригинальный, то применяется патч; если файл уже изменённый, то происходит отмена; если же данные в нём не соответствуют ни тем ни тем, то создаётся архивный патч, а потом файл подвергается пропатчиванию.
«SmartPatcher.exe %1 %2 1 *» –
Непосредственное применение патча из %1 к файлу %2. При этом он налагается, даже если файл уже модифицированный. И не создаётся никаких архивных патчей, из-за чего можно безвозвратно повредить ваши данные!
«SmartPatcher.exe %1 %2 2 *» –
Непосредственное применение патча из %1 к файлу %2 для восстановления оригинальных данных. При этом патч снимается, даже если файл уже оригинальный. И снова не создаётся никаких архивных патчей, из-за чего и здесь можно безвозвратно повредить ваши данные!
«SmartPatcher.exe %1 %2 %3 * *» –
Сравнение файлов %1 и %2 и сохранение готового патча в %3.
В автоматическом режиме игнорируются любые предупреждения и выполнение форсируется. (Кстати, звёздочки в командах «*» обязательны! Без них вы получите сообщение о неверном использовании).

Описание формата файлов патча:
Поскольку для хранения чисел используется нестандартный формат (называемый здесь «ЧИСЛО»), занимающий от 1 до 7 байт, размер полей варьируется.
В первой строке – команда запуска + CRLF. По умолчанию:
«@cd /D "%~dp0"&@SmartPatcher1V2.exe %0 %1&@exit»+перенос строки `LF`
Далее следует 1 байт со значением «0x01» – версия файла патча.
Потом 4 байта CRC суммы оригинального файла, за ними – 4 байта CRC модификата
Затем ЧИСЛО – размер оригинального файла и ЧИСЛО – размер модифицированного. Обычно они равны между собой (программа использует их только для вывода предупреждений, поэтому по большому счёту, патч будет работать и без сумм и без размеров)
Дальнейшее содержимое построено по такому принципу:
ЧИСЛО – смещение данных в файле (offset начала записи)
ЧИСЛО – размер блока данных (назовём его S)
S байт – данные оригинального файла
S байт – данные изменённого файла
Далее без разделителей может быть перечислятся следующее ЧИСЛО – смещение очередного блока (и так далее). Когда же содержимое закончится, записываются следующие данные окончания:
1 байт – число «255», то есть «0xFF», символизирующее об окончании перечисления блоков. Без него возможны ошибки ввода-вывода.
1 байт – длина BAT команды в начале файла. Программа сперва читает это значение, затем пропускает столько байт от начала файла и начинает последовательное чтение данных. Сейчас адрес равен «48», может быть изменён при изменении команды запуска.
Таким образом, размер пустого нерабочего патча равен «61» байт.

Описание формата ЧИСЛО:
В первом байте указывается часть этого числа и количество дополнительных байт с оставшейся информацией.
Если последний бит (крайний левый) равен нулю, то всё ЧИСЛО занимает один байт (этот) и не может превосходить «127».
Когда последний бит равен единице, это означает, что следует считать ещё несколько байт для числа. Их количество равно всем крайним единичным битам первого байта (слева направо). То есть например, если последние два бита единичные, а шестой бит (третий слева) нулевой, то к ЧИСЛУ относятся ещё два байта.
Максимально возможно отнести к ЧИСЛУ ещё шесть байт. Тогда в первом должны быть шесть битов (со третьего по восьмой) единичные, а второй нулевой.
Формат устроен так, что все дополнительный байты хранятся именно так, как представляют число – первый младший, последний (крайний правый) – старший. Но всё что не относится к флагам количества в первом байте (с первого бита до «последнего нулевого») образует самый старший байт ЧИСЛА (и подставляется в конец)
Если первый байт равен нулю, то (по всем предыдущим правилам) это число ноль.
Если первый байт равен 255 (не содержит нулевых бит), то это обозначает идентификатор, сигнализирующий об окончании чтения ЧИСЕЛ.
